## このプロジェクトについて

このプロジェクトは、iOSネイティブでAVFoundationを使用して、カメラ映像を取得し画面に描画する機能をシンプルに実装したものになります。
工夫している点として、内部で処理する用のデータと、プレビューしている画像の不整合がないように画像の角度などを最適に調整しています。

ライブラリなどは使用していません。

また、このプロジェクトでは、以下のケースにだけ正常にデータが表示できるように対応していて、デバイスの回転に合わせて最適な映像を表示する処理を「入れていません」

- iPhone : 縦向き
- iPad : 充電口を右側にした横向き

## 実際に動かしたときの動画

- iPad

    https://github.com/user-attachments/assets/7a890b94-3904-4790-a54d-9c0c74a0733c


- iPhone

    https://github.com/user-attachments/assets/6465f53d-a848-4382-b863-e3944f95a418

## 学んだこと・注意点(あれば)

結構学びが多かったので、細かい話は、ブログの方にまとめています。
ここでは、ざっくりと記載しています。

[【iOS】カメラ周りの機能の実装方法](https://daiki-iijima.github.io/2026/01/07/%E3%80%90iOS%E3%80%91%E3%82%AB%E3%83%A1%E3%83%A9%E5%91%A8%E3%82%8A%E3%81%AE%E6%A9%9F%E8%83%BD%E3%81%AE%E5%AE%9F%E8%A3%85%E6%96%B9%E6%B3%95/)

### データは直列ではなく、並列になる

`AVCaptureVideoPreviewLayer`と`setSampleBufferDelegate`にデータを渡しているが、これらに流れてくるsampleBufferは独立したデータなので書き換えても互いに影響し合わない

### CameraSession周りの設定時は、別スレッドで行う

ハードウェアとやり取りをする都合上、メインスレッドで処理しようとするとエラーで落ちるので注意が必要

別スレッドを作成するには、`DispatchQueue`を作成してその内部で処理をするようにする

逆に、ViewModelでCIImageをUIに設定するときはUIをいじるので、メインスレッドで処理をする必要がある

### カメラ映像はiPhoneとiPadで取得できる画像の向きが変化する

映像を回転させる場所を一箇所に絞らないと処理が追いづらくなので、このサンプルでは、`captureOutput`のハンドリグ部分でiPhone場合は縦画面でうまく表示できるように回転している

`captureOutput`が生のデータに近いので、このあとの処理は全部この角度に変換したデータを前提として処理するようになる

### AVCaptureVideoPreviewLayerはお手軽にカメラ映像を表示できるが注意が必要

いい感じに表示しようとするあまり、iPadでは映像を回転させて表示してしまうので、このサンプルでは明示的に回転しないように指示している

## どんなときに有効に使えるのか

- カメラ映像を使ったアプリケーションなどの基礎として
    - 画像解析、ビデオ通話、etc..
- iPad,iPhoneで取得できるカメラ映像が回転していることの検証として
